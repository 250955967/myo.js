<html>
	<head>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/flot/0.8.2/jquery.flot.min.js'></script>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
		<script src='./myo.js'></script>

	</head>
	<body>
		<title>Myo.js</title>
		Myo.js Test


		<div id='pan'>
			<div id='pan_x'></div>
			<div id='pan_y'></div>
		</div>


		<div id='peak'>ghj</div>
		<div id='lastpeak'>ghj</div>
		<h3>Gyroscope</h3>
		<div id='gyroscope' style="width:800px;height:150px;"></div>
		<h3>Accelerometer</h3>
		<div id='accelerometer' style="width:800px;height:150px;"></div>
		<h3>Orientation</h3>
		<div id='orientation' style="width:800px;height:150px;"></div>

<style>
	#pan{
		border : 1px solid black;
		width : 100px;
		height : 100px;
		position:relative;
	}
	#pan_x{
		position : absolute;
		border-bottom : 1px solid black;
		width : 100%;
	}
	#pan_y{
		position : absolute;
		border-right : 1px solid black;
		height : 100%;
	}
</style>

<script>

	var makeHistory = function(count, obj){
		var result =[];
		for(var i=0; i<count; i++){
			result.push(obj)
		}
		return result;
	}

	Myo.start();


	var myoHistory_size = 200;
	var myoHistory = {
		pose : [],
		orientation : makeHistory(myoHistory_size,{x:0,y:0,z:0,w:0}),
		accelerometer : makeHistory(myoHistory_size,{x:0,y:0,z:0}),
		gyroscope : makeHistory(myoHistory_size,{x:0,y:0,z:0})
	};


	Myo.on('imu', function(data){
		myoHistory.orientation.push(data.orientation);
		myoHistory.orientation = myoHistory.orientation.slice(1);
		myoHistory.accelerometer.push(data.accelerometer);
		myoHistory.accelerometer = myoHistory.accelerometer.slice(1);
		myoHistory.gyroscope.push(data.gyroscope);
		myoHistory.gyroscope = myoHistory.gyroscope.slice(1);

		//console.log(data.orientation.z);

		$('#pan_x').height((50 -data.orientation.y * 100) + '%')
		$('#pan_y').width(( data.orientation.z * 100  + 50) + '%')


		update();
	});

	var getData = function(measurement){

		var result = {};
		_.each(measurement, function(data, index){
			_.each(data, function(val, axis){
				result[axis] = result[axis] || {label : axis, data : []};
				result[axis].data.push([index, val])
			});
		});
		return _.values(result);
	}



	var plots = {
		gyroscope : $.plot("#gyroscope", getData(myoHistory.gyroscope), {
			series: {shadowSize: 0},
			//xaxis: { show: false},
			yaxis : {
				min : -400,
				max : 400
			}
		}),

		accelerometer : $.plot("#accelerometer", getData(myoHistory.accelerometer), {
			series: {shadowSize: 0},
			//xaxis: { show: false},
			yaxis : {
				min : -2.5,
				max : 2.5
			}
		}),
		orientation : $.plot("#orientation", getData(myoHistory.orientation), {
			series: {shadowSize: 0},
			//xaxis: { show: false},
			yaxis : {
				min : -1,
				max : 1
			}
		}),
	}

	var update = _.throttle(function(){
		_.each(plots, function(plot, type){
			data = getData(myoHistory[type])
			//plot.setData(data);
			//plot.draw();
		});

	}, 30);



	Myo.on('pose', function(pose){
		//document.getElementById('pose').innerHTML = pose;

		if(pose == 'spread'){
			Myo.zeroOrientation();
			Myo.requestBluetooth();
			//console.log('working');
			//peaks=[];
		}
	});


</script>
	</body>
</html>