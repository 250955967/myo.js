<html>
	<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:300,700,400' rel='stylesheet' type='text/css'>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/flot/0.8.2/jquery.flot.min.js'></script>
		<script src='http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
		<script src='./myo.js'></script>
		<script src='./experimental/myo.experimental.js'></script>

	</head>
	<body>
		<title>Myo.js</title>
		Myo.js Test

		<div id='log'></div>
		<div id='busy'></div>
		<div id='ble'>---</div>


		<div id='pan'>
			<div id='pan_x'></div>
			<div id='pan_y'></div>
		</div>
		<div id='roll'>
			<div id='roll_bar'></div>
		</div>

		<div id='coordinates'>
			[<span id='x'></span> <span id='y'></span>]
		</div>

		<div class='images'>
			<img id='fist' src='ui/img/fist.png' />
			<img id='spread' src='ui/img/spread.png' />
			<img id='thumb_to_pinky' src='ui/img/unlock.png' />
			<img id='wave_in' src='ui/img/wave_left.png' />
			<img id='wave_out' src='ui/img/wave_right.png' />
		</div>

		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
			 viewBox="0 0 47.9 37.8" enable-background="new 0 0 47.9 37.8" xml:space="preserve">
			<defs>
			        <filter id="dropGlow" width="1.5" height="1.5" x="-.25" y="-.25">
			            <feGaussianBlur id="feGaussianBlur5384" in="SourceAlpha" stdDeviation="15.000000" result="blur"/>
			            <feColorMatrix id="feColorMatrix5386" result="bluralpha" type="matrix" values="-1 0 0 0 1 0 -1 0 0 1 0 0 -1 0 1 0 0 0 0.800000 0 "/>
			            <feOffset id="feOffset5388" in="bluralpha" dx="0.000000" dy="0.000000" result="offsetBlur"/>
			            <feMerge id="feMerge5390">
			                <feMergeNode id="feMergeNode5392" in="offsetBlur"/>
			                <feMergeNode id="feMergeNode5394" in="SourceGraphic"/>
			            </feMerge>
			        </filter>
			        filter id="glow">
			            <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
			            <feMerge>
			                <feMergeNode in="coloredBlur"/>
			                <feMergeNode in="SourceGraphic"/>
			            </feMerge>
			        </filter>
			    </defs>
		<g>
			<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M34.9,20.7
				c0.1-0.8,0.2-1.6,0.3-2.8c0.1-2.8-2.6-6.6-3.3-9.1S31,1,31,1s-0.6-1.1-2.4,0c-1.8,1.1-2,3.5-1.9,7.1s-0.8,5.2-1.9,5.7
				c-1.1,0.5-2.9-1.3-4.1-2c-1.1-0.7-8.2-5.6-9.5-6.7c-1-0.9-2.5-1.3-3.4-0.7S7.2,6.6,7.8,7.6s2.4,2.8,5,4.7s3.5,2.8,3.1,3.4
				c-0.4,0.6-1,0.3-2.8-0.3c-1.8-0.5-5.2-1.9-8.3-3.4c-1.8-0.9-3.4-0.7-4.1,0.6C0,14,1.1,15.4,2.3,16.1c2.3,1.3,6.5,2.9,9.5,3.7
				c3.1,0.8,3,1.4,3,2.2c0,0.8-0.7,0.8-2.4,0.8c-1.7,0-4.4,0.1-7.6-0.1c-3.2-0.2-3.5,0.5-3.8,1.5s0.5,2.5,2.2,2.7s5,0.7,8.1,0.7
				c3.2-0.1,3.9-0.5,4.3,0.7s-0.7,1.5-1.7,2.1c-1.3,0.7-3.6,1.5-5.6,2.8c-1.9,1.3-1.9,2.6-1.4,3.2c0.9,1.1,1.8,1,3.5,0.3
				s4.9-2.2,6.8-2.9c1-0.4,2.8-0.9,4.5-1.4c1.7-0.5,5.9-0.9,9-1.9c1.5-0.4,2.2-1.2,2.5-2.2c0,0,6.4,0.4,13.1,0.9"/>
			<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M24.4,17.3
				c0,0,0.2,5.7,6.1,7.3"/>

				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M47.4, 15.1 L35.4,15.6"/>
		</g>
		</svg>

		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
			 viewBox="265.9 402.7 51.2 24.7" enable-background="new 265.9 402.7 51.2 24.7" xml:space="preserve">
		<g>
			<g>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M305.4,423.4
					c-2.5,2.5-5.2,3.6-9.3,3.6s-10.2-0.4-12.4-0.1c-3.3,0.4-4.4,0-5.3-1.2c-1.8-2.5,3-5,5.2-6.2c0.2-0.1-3.6-0.3-4.3-0.3
					c-0.8-0.1-4.2,0.9-4.9,1.6c-1.1,1.1-2.3,2.9-4.1,2c-1.9-0.9-2.5-3,0.1-5.3c-1.3,0.7-2.8,0.3-3.5-0.5c-0.8-0.9-0.5-2.7,0.3-3.3
					c1.4-1,1.5-1.1,3.2-2.3c-1.3,0.2-2.6-0.4-2.9-1.3c-0.4-1,0-2.2,0.7-2.7c1.1-0.8,3.5-2.4,5.5-2.9c2-0.5,5.2-1,6.9-1.1
					c1.7-0.1,5.2,0.3,6.9,0.4c3.3,0.2,5.2,0.7,8.8,1.4c4.6,0.9,6.5,0.7,9.9,3.5c1.8,1.5,2.4,3.3,2.4,5.2"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M294.9,407.9
					c-0.8,1.6-0.9,2.3-3.6,4.6c-2.6,2.2-3.6,2.6-4.7,4c-1.1,1.4-0.9,2.9,0,3.9s2.4,1.3,4.8-0.2c3.1-1.9,4-2.3,5.3-2.6
					c1.2-0.3,5,1.3,8.5-1.6"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M279.8,426.6
					c1.9,0.4,3.8-1.6,5.4-2.6c0.8-0.5,2.5-2.1,1.8-3.1c-0.7-1-1.8-2.1-4.2-1"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M270.2,411.4
					c0,0,0.7-0.5,1.7-0.9c1.1-0.5,4.9-1.7,6.5-1.7c1.7-0.1,6.7,0.6,6.7,0.6"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M270.4,417.3
					c0,0,1.1-1,2.1-1.7c1.1-0.7,4.5-1.7,6.1-1.7c1.6,0,5.1,0.6,5.1,0.6"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M285.9,407.4
					c0,0-2.2,5-2.6,11.8"/>
			</g>

				<line fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" x1="307.2" y1="409.6" x2="316.6" y2="409.2"/>
			<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M305.2,423.7
				c0,0,4.1,0.3,9.3,0.6"/>
		</g>
		</svg>

		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
			 viewBox="265.9 402.7 51.2 24.7" enable-background="new 265.9 402.7 51.2 24.7" xml:space="preserve">



				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M305.4,423.4
					c-2.5,2.5-5.2,3.6-9.3,3.6s-10.2-0.4-12.4-0.1c-3.3,0.4-4.4,0-5.3-1.2c-1.8-2.5,3-5,5.2-6.2c0.2-0.1-3.6-0.3-4.3-0.3
					c-0.8-0.1-4.2,0.9-4.9,1.6c-1.1,1.1-2.3,2.9-4.1,2c-1.9-0.9-2.5-3,0.1-5.3c-1.3,0.7-2.8,0.3-3.5-0.5c-0.8-0.9-0.5-2.7,0.3-3.3
					c1.4-1,1.5-1.1,3.2-2.3c-1.3,0.2-2.6-0.4-2.9-1.3c-0.4-1,0-2.2,0.7-2.7c1.1-0.8,3.5-2.4,5.5-2.9c2-0.5,5.2-1,6.9-1.1
					c1.7-0.1,5.2,0.3,6.9,0.4c3.3,0.2,5.2,0.7,8.8,1.4c4.6,0.9,6.5,0.7,9.9,3.5c1.8,1.5,2.4,3.3,2.4,5.2"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M294.9,407.9
					c-0.8,1.6-0.9,2.3-3.6,4.6c-2.6,2.2-3.6,2.6-4.7,4c-1.1,1.4-0.9,2.9,0,3.9s2.4,1.3,4.8-0.2c3.1-1.9,4-2.3,5.3-2.6
					c1.2-0.3,5,1.3,8.5-1.6"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M279.8,426.6
					c1.9,0.4,3.8-1.6,5.4-2.6c0.8-0.5,2.5-2.1,1.8-3.1c-0.7-1-1.8-2.1-4.2-1"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M270.2,411.4
					c0,0,0.7-0.5,1.7-0.9c1.1-0.5,4.9-1.7,6.5-1.7c1.7-0.1,6.7,0.6,6.7,0.6"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M270.4,417.3
					c0,0,1.1-1,2.1-1.7c1.1-0.7,4.5-1.7,6.1-1.7c1.6,0,5.1,0.6,5.1,0.6"/>
				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M285.9,407.4
					c0,0-2.2,5-2.6,11.8"/>

				<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M316.6,409.2 L307.2,409.6"/>
			<path fill="none" stroke="#1E1E1E" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M305.2,423.7
				c0,0,4.1,0.3,9.3,0.6"/>


		</svg>


		<div id='gyroscope' class='plot'></div>
		<div id='accelerometer' class='plot'></div>
		<div id='orientation' class='plot'></div>

<style>
	body{
		background-color : #0A0A0A;

		color : #84FFF1;
		font-family: 'Open Sans', sans-serif;
	}

	svg{
		width : 300px;

	}

	path {
		stroke : white;
		-webkit-transition : stroke-dashoffset 2s ease-in-out
	}

	line {
		stroke : white;
		-webkit-transition : stroke-dashoffset 2s ease-in-out
	}

	#coordinates{
		font-family : courier;
		font-size : 0.7em;
	}

	#roll{
		display : inline-block;
		margin : 10px;
		border-radius : 5em;
		border : 1px solid #84FFF1;
		width : 100px;
		height : 100px;
		position:relative;
	}
	#roll_bar{
		background-color : #427F78;
		width : 1px;
		height : 50%;
		position : absolute;
		left : 50%;

		-webkit-transform : rotate(45deg);
		-webkit-transform-origin : center bottom;
	}
	#pan{
		overflow : hidden;
		display : inline-block;
		margin : 10px;
		border : 1px solid #84FFF1;
		width : 100px;
		height : 100px;
		position:relative;
	}
	#pan_y{
		position : absolute;
		border-bottom : 1px solid #427F78;
		width : 100%;
	}
	#pan_x{
		position : absolute;
		border-right : 1px solid #427F78;
		height : 100%;
	}
	.images img{
		width : 100px;
		display: none;
	}
	.plot{
		width:200px;
		height:600px;
		display : inline-block;

	}
</style>

<script>

	var showPose = function(poseName){
		$('.images img').hide();
		$('#' + poseName).show();
	}

	var makeHistory = function(count, obj){
		var result =[];
		for(var i=0; i<count; i++){
			result.push(obj)
		}
		return result;
	}

	$('path').each(function(){
		var length = $(this)[0].getTotalLength();

		var self = this;

		$(this).css({
			'stroke-dashoffset' : length,
			'stroke-dasharray' : length + ' ' + length
		})

		setTimeout(function(){
			$(self).css({
				'stroke-dashoffset' : '0'
			});
		}, 1000);

	})



	var createGraph = function(containerElementId, initialData, ranges){





		var plot = $.plot(containerElementId, getData(myoHistory.orientation), {
			series: {shadowSize: 0},
			yaxis : {
				min : ranges[0],
				max : ranges[1]
			}
		});

		var history = {


		}



		return {
			plot : plot,
			addData : function(dataPoint){
				data = getData(myoHistory[type])
				plot.setData(data);
				plot.draw();
			},
			clearData : function(){

			}
		}
	}



	Myo.start();


	Myo.isLocked = true;


	//Myo.options.armbusy_threshold = 20;


	var maGyro = 0;


	var myoHistory_size = 100;
	var myoHistory = {
		pose : [],
		orientation : makeHistory(myoHistory_size,{x:0,y:0,z:0,w:0}),
		accelerometer : makeHistory(myoHistory_size,{x:0,y:0,z:0}),
		gyroscope : makeHistory(myoHistory_size,{x:0,y:0,z:0,ema:0})
	};




	Myo.on('imu', function(data){

		myoHistory.orientation.push(data.orientation);
		myoHistory.orientation = myoHistory.orientation.slice(1);
		myoHistory.accelerometer.push(data.accelerometer);
		myoHistory.accelerometer = myoHistory.accelerometer.slice(1);


		data.gyroscope.ema = Myo.armBusyData;

		myoHistory.gyroscope.push(data.gyroscope);
		myoHistory.gyroscope = myoHistory.gyroscope.slice(1);

		//console.log(data.orientation.z);



		if(Myo.armIsBusy){
			$('#busy').html('BUSY');
		}else{
			$('#busy').html('----');
		}

		if(hasFist && data.gyroscope.z > data.gyroscope.y + 150){
			console.log('PUNCH');
		}






		//y*0.5 of x

		var inverse = (Myo.x_direction == 'toward_wrist') ? 1 : -1;


		var y = (data.orientation.x - data.orientation.y/2) * inverse;
		var x = data.orientation.w * inverse;
		var roll = (data.orientation.y * -180) * inverse;


		$('#pan_y').height( (y + 0.5)*100 + '%');
		$('#pan_x').width( (x + 0.5)*100 + '%');

		$('#roll_bar').css({
			'-webkit-transform' : 'rotate(' + roll + 'deg)'
		});

		$('#x').html(x.toFixed(2))
		$('#y').html(y.toFixed(2))





		update();
	});

	var getData = function(measurement){

		var result = {};
		_.each(measurement, function(data, index){
			_.each(data, function(val, axis){
				result[axis] = result[axis] || {label : axis, data : []};
				result[axis].data.push([val, index])
			});
		});
		return _.values(result);
	}

	var hasFist = false;

	Myo.on('fist', function(edge){
		hasFist = edge;
	})



	var plots = {
		gyroscope : $.plot("#gyroscope", getData(myoHistory.gyroscope), {
			series: {shadowSize: 0},
			colors: [ '#84FFF1', '#FFF38A', '#FF4B23', '#00797F'],
			xaxis: {
				min : -400,
				max : 400
			},
			yaxis : {
				show: false,
				min : 0,
				max : myoHistory_size
			},
			legend : {
				backgroundOpacity : 0,
			},
			grid : {
				borderColor : "#427F78"
			}
		}),

		accelerometer : $.plot("#accelerometer", getData(myoHistory.accelerometer), {
			series: {shadowSize: 0},
			colors: [ '#84FFF1', '#FFF38A', '#FF4B23', '#00797F'],
			xaxis: {
				min : -2.5,
				max : 2.5
			},
			yaxis : {
				show: false,
				min : 0,
				max : myoHistory_size
			},
			legend : {
				backgroundOpacity : 0,
			},
			grid : {
				borderColor : "#427F78"
			}
		}),
		orientation : $.plot("#orientation", getData(myoHistory.orientation), {
			series: {shadowSize: 0},
			colors: [ '#84FFF1', '#FFF38A', '#FF4B23', '#00797F'],
			xaxis: {
				min : -1,
				max : 1
			},
			yaxis : {
				show: false,
				min : 0,
				max : myoHistory_size
			},
			legend : {
				backgroundOpacity : 0,
			},
			grid : {
				borderColor : "#427F78"
			}
		}),
	}

	var update = _.throttle(function(){
		_.each(plots, function(plot, type){
			data = getData(myoHistory[type])
			plot.setData(data);
			plot.draw();
		});

	}, 20);


	Myo.on('arm_recognized', function(){
		console.log('arm back', Myo.x_direction);
	})


	Myo.on('bluetooth_strength', function(val){
		$('#ble').html(val);
	});


	var filterPose = function(pose){
		console.log('YEAH', pose);
		//Myo.vibrate('short');

		showPose(pose);
	}


	var poseHold;
	Myo.on('pose', function(pose, edge){
		if(Myo.isLocked || pose == 'rest') return;

		Myo.unlock(edge ? 0 : 5000);

		Myo.timer(edge, 200, function(){
			filterPose(pose);
		})

		//console.log(pose, edge);


		if(pose == 'spread'){
			Myo.zeroOrientation();
			Myo.requestBluetooth();
			//console.log('working');
			//peaks=[];
		}

	});


	Myo.on('unlock', function(){
		//Myo.vibrate('short').vibrate('short');
		console.log('unlocked');
	})

	Myo.on('lock', function(){
		//Myo.vibrate('medium');
		console.log('locked');
	})


	Myo.on('thumb_to_pinky', function(edge){
		hasFist = edge;
		if(!Myo.isLocked || Myo.armIsBusy) return;

		//if(edge) Myo.vibrate('short');

		Myo.timer(edge, 500, function(){
			//Myo.unlock(2000);
		});
	});



	Myo.on('double_tap', function(){
		Myo.zeroOrientation();
		Myo.mouse = [0,0];
		if(Myo.isLocked){
			Myo.unlock()
		}else{
			Myo.lock();
		}

	})


</script>
	</body>
</html>